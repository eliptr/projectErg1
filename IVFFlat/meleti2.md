# Πειραματική Μελέτη - IVFFlat Algorithm

**Κ23γ: Ανάπτυξη Λογισμικού για Αλγοριθμικά Προβλήματα**  
**Εργασία 1 - Μέρος 2**

---

## 1. Εισαγωγή

Η παρούσα μελέτη αξιολογεί την απόδοση του αλγορίθμου **IVFFlat (Inverted File Flat)** για προσεγγιστική αναζήτηση πλησιέστερων γειτόνων. Ο αλγόριθμος χρησιμοποιεί **k-means clustering** για να οργανώσει τα δεδομένα σε clusters και στη συνέχεια πραγματοποιεί γρήγορη αναζήτηση ελέγχοντας μόνο τα πιο κοντινά clusters.

### Datasets

- **MNIST**: 60,000 εικόνες χειρόγραφων ψηφίων (784 διαστάσεις, 28×28 pixels)
- **SIFT1M**: 1,000,000 SIFT descriptors (128 διαστάσεις)

### Μετρικές Αξιολόγησης

| Μετρική | Περιγραφή | Βέλτιστο |
|---------|-----------|----------|
| **Recall@N** | Ποσοστό σωστών N-NN που βρέθηκαν | ↑ (κοντά στο 1.0) |
| **AF** | Average Approximation Factor | ↓ (κοντά στο 1.0) |
| **QPS** | Queries Per Second | ↑ |
| **Speedup** | Επιτάχυνση vs brute force | ↑ |
| **Silhouette** | Ποιότητα clustering | ↑ (> 0.5 = καλό) |

---

## 2. Πειραματικές Παράμετροι

Εξετάστηκαν οι εξής παράμετροι:

- **k-clusters**: {20, 30, 50, 75, 100} για MNIST, {50, 100, 150, 200, 300} για SIFT
- **nprobe**: {1, 3, 5, 10, 15, 20} για MNIST, {1, 5, 10, 20, 30, 50} για SIFT
- **N** (αριθμός γειτόνων): {1, 5, 10, 20, 50, 100}
- **seed**: {1, 42, 123, 999, 2025}
- **R** (ακτίνα): {500, 1000, 1500, 2000, 3000, 5000} για MNIST

**Συνολικά**: 48 πειράματα (30 MNIST, 18 SIFT)

---

## 3. Αποτελέσματα MNIST

### 3.1 Επίδραση του k-clusters (nprobe = 10% kclusters)

| k-clusters | Silhouette | Recall@10 | QPS | Speedup |
|------------|------------|-----------|-----|---------|
| 20 | 0.1032 | 91.6% | 21,258 | 4.05x |
| 30 | 0.0943 | 83.0% | 23,364 | 5.32x |
| 50 | 0.0827 | 91.0% | 21,258 | 4.30x |
| 75 | 0.0815 | 93.6% | 17,117 | 3.23x |
| 100 | 0.0749 | **96.8%** | 15,408 | 3.03x |

**Παρατηρήσεις**:
- Αύξηση k → υψηλότερο Recall αλλά χαμηλότερη ταχύτητα
- k=100 δίνει το καλύτερο Recall (96.8%) αλλά πιο αργό QPS
- k=20 έχει το υψηλότερο Silhouette (0.1032) αλλά χαμηλότερο Recall από k=50,75,100

### 3.2 Επίδραση του nprobe

| nprobe | Recall@10 | AF | QPS | Speedup |
|--------|-----------|-----|-----|---------|
| 1 | 48.2% | 1.092 | **40,096** | **7.63x** |
| 3 | 79.0% | 1.014 | 28,280 | 5.23x |
| 5 | 91.0% | 1.004 | 22,094 | 4.15x |
| 10 | 97.8% | 1.000 | 14,806 | 2.77x |
| 15 | **99.4%** | **1.000** | 10,620 | 2.61x |
| 20 | **99.4%** | **1.000** | 9,072 | 1.71x |

**Παρατηρήσεις**:
- Σαφής trade-off: **ταχύτητα ↔ ακρίβεια**
- nprobe=1: Πολύ γρήγορο (40k QPS) αλλά χαμηλό Recall (48%)
- nprobe=5: **Sweet spot** - καλή ισορροπία (91% Recall, 22k QPS)
- nprobe≥15: Εξαιρετικό Recall (99.4%) αλλά χαμηλή ταχύτητα

### 3.3 Επίδραση του N (αριθμός γειτόνων)

| N | Recall@N | AF | QPS |
|---|----------|-----|-----|
| 1 | 98.0% | 1.000 | 22,904 |
| 5 | 95.2% | 1.002 | 21,663 |
| 10 | 91.0% | 1.004 | 22,351 |
| 20 | 85.1% | 1.007 | 21,815 |
| 50 | 69.8% | 1.027 | 22,222 |
| 100 | 61.5% | 1.047 | 22,007 |

**Παρατηρήσεις**:
- Μεγαλύτερο N → χαμηλότερο Recall (πιο δύσκολο να βρεις όλους τους N-NN)
- QPS παραμένει σταθερό (~22k) ανεξάρτητα από το N
- N=1 έχει το υψηλότερο Recall (98%)

### 3.4 Επίδραση του seed

| seed | Silhouette | Recall@10 | AF |
|------|------------|-----------|-----|
| 1 | 0.0827 | 91.0% | 1.004 |
| 42 | 0.0689 | 90.0% | 1.005 |
| 123 | **0.0851** | **92.0%** | 1.004 |
| 999 | **0.0859** | 84.8% | 1.007 |
| 2025 | 0.0789 | 88.8% | 1.006 |

**Παρατηρήσεις**:
- Seed επηρεάζει το k-means initialization
- Διαφορές στο Recall: ±4% (87-92%)
- Διαφορές στο Silhouette: ±0.017 (0.069-0.086)
- seed=123 δίνει την καλύτερη ισορροπία

### 3.5 Συγκριτική Αξιολόγηση Configurations

| Config | k-clusters | nprobe | Recall@10 | QPS | Speedup |
|--------|------------|--------|-----------|-----|---------|
| **Fast** | 20 | 2 | 81.6% | **30,525** | **5.63x** |
| **Balanced** | 50 | 5 | 91.0% | 21,891 | 4.39x |
| **Accurate** | 100 | 20 | **99.2%** | 10,926 | 2.12x |

---

## 4. Αποτελέσματα SIFT

### 4.1 Επίδραση του k-clusters

| k-clusters | Silhouette | Recall@10 | QPS | Speedup |
|------------|------------|-----------|-----|---------|
| 50 | **0.0433** | 92.9% | 7,596 | **8.25x** |
| 100 | 0.0361 | 95.9% | 7,163 | 7.75x |
| 150 | 0.0372 | 97.2% | 6,944 | 7.54x |
| 200 | 0.0402 | 97.8% | 6,198 | 7.10x |
| 300 | 0.0416 | **98.7%** | 5,983 | 6.59x |

**Παρατηρήσεις**:
- SIFT: Χαμηλότερο Silhouette από MNIST (δυσκολότερο dataset)
- k=300 δίνει 98.7% Recall αλλά χάνει ~20% ταχύτητα
- k=50 καλύτερη ισορροπία (92.9% Recall, υψηλότερο speedup)

### 4.2 Επίδραση του nprobe

| nprobe | Recall@10 | QPS | Speedup |
|--------|-----------|-----|---------|
| 1 | 44.8% | **46,217** | **51.44x** |
| 5 | 86.0% | 13,521 | 15.07x |
| 10 | 95.9% | 7,025 | 7.87x |
| 20 | 99.7% | 3,545 | 4.04x |
| 30 | **100.0%** | 2,491 | 2.79x |
| 50 | **100.0%** | 1,650 | 1.85x |

**Παρατηρήσεις**:
- nprobe=1: Εντυπωσιακό speedup (51x!) αλλά χαμηλό Recall (45%)
- nprobe=10: **Βέλτιστο σημείο** (96% Recall, 7.9x speedup)
- nprobe≥30: Τέλειο Recall (100%) αλλά πολύ αργό

### 4.3 Συγκριτική Αξιολόγηση Configurations

| Config | k-clusters | nprobe | Recall@10 | QPS | Speedup |
|--------|------------|--------|-----------|-----|---------|
| **Fast** | 50 | 5 | 92.9% | 7,265 | **8.10x** |
| **Balanced** | 100 | 10 | 95.9% | 6,902 | 7.81x |
| **Accurate** | 200 | 30 | **99.4%** | 4,550 | 5.07x |

---

## 5. Συγκριτική Ανάλυση

### 5.1 MNIST vs SIFT

| Μετρική | MNIST (best) | SIFT (best) |
|---------|--------------|-------------|
| Max Recall@10 | 99.4% (nprobe=15) | 100.0% (nprobe=30) |
| Max QPS | 40,096 (nprobe=1) | 46,217 (nprobe=1) |
| Max Speedup | 7.63x (nprobe=1) | 51.44x (nprobe=1) |
| Best Silhouette | 0.1032 (k=20) | 0.0433 (k=50) |

**Παρατηρήσεις**:
- SIFT έχει **πολύ υψηλότερο speedup** (51x vs 7.6x) λόγω μεγαλύτερου dataset
- MNIST έχει καλύτερο clustering (υψηλότερο Silhouette)
- Και τα δύο datasets επιτυγχάνουν >99% Recall με κατάλληλες παραμέτρους

### 5.2 Trade-off Analysis

```
              MNIST                          SIFT
         ┌─────────────┐              ┌─────────────┐
Fast     │ 81.6% @ 30k │              │ 92.9% @ 7k  │
         │ QPS         │              │ QPS         │
         └─────────────┘              └─────────────┘
              ↓                            ↓
Balanced │ 91.0% @ 22k │              │ 95.9% @ 7k  │
         │ QPS         │              │ QPS         │
         └─────────────┘              └─────────────┘
              ↓                            ↓
Accurate │ 99.2% @ 11k │              │ 99.4% @ 4.5k│
         │ QPS         │              │ QPS         │
         └─────────────┘              └─────────────┘
```

---

## 6. Βασικά Συμπεράσματα

### 6.1 Κύρια Ευρήματα

1. **Trade-off ταχύτητας-ακρίβειας**: Υπάρχει σαφής ανταλλαγή μεταξύ Recall και QPS
   - Χαμηλό nprobe → Γρήγορο αλλά ανακριβές
   - Υψηλό nprobe → Αργό αλλά ακριβές

2. **Βέλτιστες παράμετροι**:
   - **MNIST Balanced**: k=50, nprobe=5 → 91% Recall @ 22k QPS
   - **SIFT Balanced**: k=100, nprobe=10 → 96% Recall @ 7k QPS

3. **Επίδραση k-clusters**:
   - Περισσότερα clusters → Καλύτερο Recall αλλά χαμηλότερη ταχύτητα
   - Χαμηλότερο Silhouette με περισσότερα clusters

4. **Speedup**:
   - SIFT: **7-50x** γρηγορότερο από brute force
   - MNIST: **2-8x** γρηγορότερο από brute force

### 6.2 Συστάσεις

| Σενάριο | Παράμετροι | Απόδοση |
|---------|------------|---------|
| **Real-time applications** | k=20-50, nprobe=1-3 | 80-85% Recall, >25k QPS |
| **Production systems** | k=50-100, nprobe=5-10 | 91-96% Recall, 7-22k QPS |
| **Offline/High accuracy** | k=100-200, nprobe=20-30 | >99% Recall, 2-10k QPS |

### 6.3 Περιορισμοί

- Το Silhouette score είναι σχετικά χαμηλό (<0.11) υποδεικνύοντας overlapping clusters
- Το N επηρεάζει το Recall (μεγαλύτερο N → χαμηλότερο Recall)
- Το seed επηρεάζει τα αποτελέσματα (±4% διακύμανση στο Recall)

---

## 7. Συμπεράσματα

Ο αλγόριθμος **IVFFlat** αποδεικνύεται αποτελεσματικός για προσεγγιστική αναζήτηση πλησιέστερων γειτόνων, επιτυγχάνοντας:

✅ **Υψηλή ακρίβεια**: 90-99% Recall με κατάλληλες παραμέτρους  
✅ **Σημαντική επιτάχυνση**: 7-51x γρηγορότερο από brute force  
✅ **Ευελιξία**: Ρυθμιζόμενο trade-off ταχύτητας-ακρίβειας  
✅ **Κλιμάκωση**: Αποτελεσματικό σε μεγάλα datasets (1M vectors)

Η **balanced configuration** (k=50-100, nprobe=5-10) προτείνεται για τις περισσότερες εφαρμογές, επιτυγχάνοντας >91% Recall με εξαιρετική ταχύτητα.